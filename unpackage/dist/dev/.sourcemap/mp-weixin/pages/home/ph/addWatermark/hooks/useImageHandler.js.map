{"version":3,"file":"useImageHandler.js","sources":["pages/home/ph/addWatermark/hooks/useImageHandler.js"],"sourcesContent":["import { ref } from 'vue'\n\nexport const useImageHandler = (canvasId) => {\n  const imageInfo = ref({\n    canvasWidth: 0,\n    canvasHeight: 0,\n    url: ''\n  })\n  const originalImage = ref(null)\n  const isProcessing = ref(false)\n  // 计算图片在容器中的绘制尺寸\n  const calculateDrawSize = (containerWidth, containerHeight, imageWidth, imageHeight) => {\n    const containerRatio = containerWidth / containerHeight\n    const imageRatio = imageWidth / imageHeight\n    let drawWidth, drawHeight, x, y\n\n    if (imageRatio > containerRatio) {\n      // 图片较宽，以容器宽度为准\n      drawWidth = containerWidth\n      drawHeight = containerWidth / imageRatio\n      x = 0\n      y = (containerHeight - drawHeight) / 2\n    } else {\n      // 图片较高，以容器高度为准\n      drawHeight = containerHeight\n      drawWidth = containerHeight * imageRatio\n      x = (containerWidth - drawWidth) / 2\n      y = 0\n    }\n\n    return { drawWidth, drawHeight, x, y }\n  }\n\n  const handleImageSelect = async () => {\n    try {\n      isProcessing.value = true\n      \n      // 选择图片\n      const { tempFiles } = await uni.chooseImage({\n        count: 1,\n        sizeType: [\"original\"],\n        sourceType: [\"album\"],\n      })\n\n      const tempFile = tempFiles[0]\n      \n      // 获取容器尺寸\n      const container = await new Promise(resolve => {\n        const query = uni.createSelectorQuery()\n        query.select('.preview-wrapper')\n          .boundingClientRect(data => {\n            resolve(data)\n          }).exec()\n      })\n\n      // 获取图片信息\n      const imgInfo = await new Promise((resolve, reject) => {\n        uni.getImageInfo({\n          src: tempFile.path,\n          success: resolve,\n          fail: reject\n        })\n      })\n\n      // 计算绘制尺寸\n      const { drawWidth, drawHeight, x, y } = calculateDrawSize(\n        container.width,\n        container.height,\n        imgInfo.width,\n        imgInfo.height\n      )\n\n      // 保存图片信息\n      originalImage.value = tempFile\n      imageInfo.value = {\n        path: tempFile.path,          // 图片临时文件路径\n        width: imgInfo.width,         // 图片原始宽度（单位：px）\n        height: imgInfo.height,       // 图片原始高度（单位：px）\n        fileSize: (tempFile.size / 1024).toFixed(0),  // 文件体积（单位：KB，四舍五入取整）\n        x,                            // 图片在画布中的水平起始位置（单位：px）\n        y,                            // 图片在画布中的垂直起始位置（单位：px）\n        drawWidth,                    // 图片在画布中的绘制宽度（适配容器后的尺寸）\n        drawHeight,                   // 图片在画布中的绘制高度（适配容器后的尺寸）\n        canvasWidth: container.width,  // 画布容器实际宽度（预览区域宽度）\n        canvasHeight: container.height // 画布容器实际高度（预览区域高度）\n      }\n\n      console.log('图片信息:', imageInfo.value)\n      return imageInfo.value\n      \n    } catch (error) {\n      console.error('选择图片失败:', error)\n      uni.showToast({\n        title: '选择图片失败',\n        icon: 'none'\n      })\n    } finally {\n      isProcessing.value = false\n    }\n  }\n\n\n  //绘制图片\n  const drawImage = async () => {\n    try {\n      const ctx = uni.createCanvasContext(canvasId)\n      // 清空画布\n      ctx.clearRect(0, 0, imageInfo.canvasWidth, imageInfo.canvasHeight)\n      \n      // 绘制原图\n      ctx.drawImage(\n        imageInfo.path,\n        imageInfo.x,\n        imageInfo.y,\n        imageInfo.drawWidth,\n        imageInfo.drawHeight\n      )\n\n      // 应用绘制\n      await new Promise(resolve => ctx.draw(false, resolve))\n\n    } catch (error) {\n      console.error('绘制失败:', error)\n      uni.showToast({\n        title: '绘制失败',\n        icon: 'none'\n      })\n    }\n    \n  }\n\n  return {\n    imageInfo,\n    isProcessing,\n    handleImageSelect,\n    drawImage\n  }\n}\n"],"names":["ref","uni"],"mappings":"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"}