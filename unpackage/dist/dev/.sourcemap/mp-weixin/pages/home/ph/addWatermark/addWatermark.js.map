{"version":3,"file":"addWatermark.js","sources":["pages/home/ph/addWatermark/addWatermark.vue","pages/home/ph/addWatermark/addWatermark.vue?type=page"],"sourcesContent":["<script setup>\r\nimport page from \"@/components/pages/page.vue\";\r\nimport { ref } from 'vue'\r\nimport { useImageHandler } from './hooks/useImageHandler'\r\nimport { useWatermark } from './hooks/useWatermark'\r\nimport { useWatermarkForm } from './hooks/useWatermarkForm'\r\nimport { WATERMARK_TYPES } from './components/watermarkConfig'\r\nimport WatermarkTypeSelector from './components/WatermarkTypeSelector.vue'\r\nimport WatermarkForm from './components/WatermarkForm.vue'\r\n\r\nconst watermarkType = ref(1)\r\nconst currentStyle = ref(WATERMARK_TYPES[0].style)\r\n\r\nconst { imageInfo, isProcessing, handleImageSelect } = useImageHandler()\r\nconst { addWatermark } = useWatermark('watermark')\r\nconst { formData, getFormFields, validateForm, resetForm } = useWatermarkForm()\r\n\r\n// 处理水印类型变化\r\nconst handleTypeChange = (item) => {\r\n\tconsole.log('style',item)\r\n\tcurrentStyle.value = item.style\r\n\twatermarkType.value = item.id\r\n  if (imageInfo.value) {\r\n    updateWatermark()\r\n  }\r\n}\r\n\r\n// 更新水印\r\nconst updateWatermark = async () => {\r\n  console.log('formData',formData.value)\r\n  if (!imageInfo.value || !currentStyle.value) return\r\n\tawait addWatermark({\r\n    image: imageInfo.value,\r\n    style: currentStyle.value,\r\n    info: formData.value\r\n  })\r\n}\r\n\r\n// 处理图片选择\r\nconst onImageSelect = async () => {\r\n  if (isProcessing.value) return\r\n  const image = await handleImageSelect()\r\n  if (image) {\r\n    await updateWatermark() // 更新水印\r\n  }\r\n}\r\n\r\n// 生成最终图片\r\nconst generateImage = async () => {\r\n  if (!imageInfo.value) {\r\n    uni.showToast({\r\n      title: '请先选择图片',\r\n      icon: 'none'\r\n    })\r\n    return\r\n  }\r\n\r\n  try {\r\n    const { x,y,drawWidth, drawHeight  } = imageInfo.value;\r\n    const { tempFilePath } = await uni.canvasToTempFilePath({\r\n      canvasId: 'watermark',\r\n      fileType: 'png', // 使用 PNG 格式以保证无损\r\n      quality: 1, // 设置图片质量为最高\r\n      x: x + 0.1, // 截取区域的左上角 x 坐标\r\n      y: y + 0.1, // 截取区域的左上角 y 坐标\r\n      width: drawWidth - 0.5, // 截取区域的宽度，使用图片实际绘制的宽度\r\n      height: drawHeight - 0.5 // 截取区域的高度，使用图片实际绘制的高度\r\n    });\r\n\r\n    console.log('生成图片成功', tempFilePath);\r\n    uni.showToast({\r\n      title: '生成图片成功',\r\n      icon: 'success'\r\n    });\r\n\r\n    // 预览图片\r\n    uni.previewImage({\r\n      urls: [tempFilePath],\r\n      longPressActions: {\r\n        itemList: ['保存图片'],\r\n        success: function (data) {\r\n          if (data.tapIndex === 0) {\r\n            // 保存图片到相册\r\n            uni.saveImageToPhotosAlbum({\r\n              filePath: tempFilePath,\r\n              success: function () {\r\n                uni.showToast({\r\n                  title: '保存成功',\r\n                  icon: 'success'\r\n                });\r\n              },\r\n              fail: function (err) {\r\n                console.error('保存失败', err);\r\n                uni.showToast({\r\n                  title: '保存失败',\r\n                  icon: 'none'\r\n                });\r\n              }\r\n            });\r\n          }\r\n        },\r\n        fail: function (err) {\r\n          console.error('长按操作失败', err);\r\n        }\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('生成图片出错', error);\r\n    uni.showToast({\r\n      title: '生成图片出错',\r\n      icon: 'none'\r\n    });\r\n  }\r\n};\r\n\r\n\r\n\r\n</script>\r\n\r\n<template>\r\n  <page\r\n    title=\"添加水印\"\r\n    rButton=\"生成图片\"\r\n    :rButtonDisabled=\"isProcessing\"\r\n    @rButton=\"generateImage\"\r\n  >\r\n    <view class=\"content\">\r\n     \r\n      <!-- 画布区域 -->\r\n      <view \r\n        id=\"contentMain\" \r\n        class=\"content-main\"\r\n        @click=\"onImageSelect\"\r\n      >\r\n        <canvas \r\n          canvas-id=\"watermark\"\r\n          class=\"watermark-canvas\"\r\n          :style=\"{\r\n            width: imageInfo?.canvasWidth + 'px',\r\n            height: imageInfo?.canvasHeight + 'px'\r\n          }\"\r\n        />\r\n        <view v-if=\"!imageInfo\" class=\"placeholder\">\r\n          <u-icon name=\"camera-fill\" size=\"40\" color=\"#999\"/>\r\n          <text class=\"placeholder-text\">点击选择图片</text>\r\n        </view>\r\n      </view>\r\n      \r\n\t\t\t <!-- 水印类型选择器 -->\r\n\t\t\t <WatermarkTypeSelector\r\n        v-model=\"watermarkType\"\r\n        @handleTypeChange=\"handleTypeChange\"\r\n      />\r\n      \r\n      <!-- 表单区域 -->\r\n      <WatermarkForm\r\n        v-if=\"currentStyle\"\r\n        v-model=\"formData\"\r\n        :fields=\"getFormFields(currentStyle)\"\r\n        :disabled=\"isProcessing\"\r\n        @dataChanged=\"updateWatermark\"\r\n      />\r\n    </view>\r\n  </page>\r\n</template>\r\n\r\n<style lang=\"less\" scoped>\r\n.content {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 15px;\r\n  padding: 10px;\r\n  background: #e6e6e6;\r\n\r\n  .content-main {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 600px;\r\n    background: #ffffff;\r\n    border-radius: 8px;\r\n    overflow: hidden;\r\n    \r\n    .watermark-canvas {\r\n      width: 100%;\r\n      height: 100%;\r\n    }\r\n    \r\n    .placeholder {\r\n      position: absolute;\r\n      top: 50%;\r\n      left: 50%;\r\n      transform: translate(-50%, -50%);\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      gap: 10px;\r\n      \r\n      .placeholder-text {\r\n        font-size: 14px;\r\n        color: #999;\r\n      }\r\n    }\r\n  }\r\n}\r\n</style> \r\n","import MiniProgramPage from '/Users/pq/code/ph/pages/home/ph/addWatermark/addWatermark.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","WATERMARK_TYPES","useImageHandler","useWatermark","useWatermarkForm","uni"],"mappings":"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"}