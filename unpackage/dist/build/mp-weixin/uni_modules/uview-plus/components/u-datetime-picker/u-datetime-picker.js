"use strict";const e=require("../../../../common/vendor.js"),t=require("./props.js"),i=require("../../libs/mixin/mpMixin.js"),n=require("../../libs/mixin/mixin.js");const r={name:"datetime-picker",mixins:[i.mpMixin,n.mixin,t.props],data:()=>({columns:[],innerDefaultIndex:[],innerFormatter:(e,t)=>t}),watch:{show(e,t){e&&this.updateColumnValue(this.innerValue)},propsChange(){this.init()}},computed:{propsChange(){return[this.mode,this.maxDate,this.minDate,this.minHour,this.maxHour,this.minMinute,this.maxMinute,this.filter]}},mounted(){this.init()},emits:["close","cancel","confirm","change"],methods:{init(){this.innerValue=this.correctValue(this.modelValue),this.updateColumnValue(this.innerValue)},setFormatter(e){this.innerFormatter=e},close(){this.closeOnClickOverlay&&this.$emit("close")},cancel(){this.$emit("cancel")},confirm(){this.$emit("confirm",{value:this.innerValue,mode:this.mode}),this.$emit("update:modelValue",this.innerValue)},intercept(t,i){let n=t.match(/\d+/g);return n.length>1?(e.index.$u.error("请勿在过滤或格式化函数时添加数字"),0):i&&4==n[0].length?n[0]:n[0].length>2?(e.index.$u.error("请勿在过滤或格式化函数时添加数字"),0):n[0]},change(t){const{indexs:i,values:n}=t;let r="";if("time"===this.mode)r=`${this.intercept(n[0][i[0]])}:${this.intercept(n[1][i[1]])}`;else{const t=parseInt(this.intercept(n[0][i[0]],"year")),a=parseInt(this.intercept(n[1][i[1]]));let s=parseInt(n[2]?this.intercept(n[2][i[2]]):1),o=0,m=0;const u=e.dayjs(`${t}-${a}`).daysInMonth();"year-month"===this.mode&&(s=1),s=Math.min(u,s),"datetime"===this.mode&&(o=parseInt(this.intercept(n[3][i[3]])),m=parseInt(this.intercept(n[4][i[4]]))),r=Number(new Date(t,a-1,s,o,m))}r=this.correctValue(r),this.innerValue=r,this.updateColumnValue(r),this.$emit("change",{value:r,mode:this.mode})},updateColumnValue(e){this.innerValue=e,this.updateColumns(),this.updateIndexs(e)},updateIndexs(t){let i=[];const n=this.formatter||this.innerFormatter,r=e.index.$u.padZero;if("time"===this.mode){const e=t.split(":");i=[n("hour",e[0]),n("minute",e[1])]}else i=[n("year",`${e.dayjs(t).year()}`),n("month",r(e.dayjs(t).month()+1))],"date"===this.mode&&i.push(n("day",r(e.dayjs(t).date()))),"datetime"===this.mode&&i.push(n("day",r(e.dayjs(t).date())),n("hour",r(e.dayjs(t).hour())),n("minute",r(e.dayjs(t).minute())));const a=this.columns.map(((e,t)=>Math.max(0,e.findIndex((e=>e===i[t])))));this.innerDefaultIndex=a},updateColumns(){const e=this.formatter||this.innerFormatter,t=this.getOriginColumns().map((t=>t.values.map((i=>e(t.type,i)))));this.columns=t},getOriginColumns(){return this.getRanges().map((({type:t,range:i})=>{let n=function(e,t){let i=-1;const n=Array(e<0?0:e);for(;++i<e;)n[i]=t(i);return n}(i[1]-i[0]+1,(n=>{let r=i[0]+n;return r="year"===t?`${r}`:e.index.$u.padZero(r),r}));return this.filter&&(n=this.filter(t,n)),{type:t,values:n}}))},generateArray:(e,t)=>Array.from(new Array(t+1).keys()).slice(e),correctValue(t){const i="time"!==this.mode;if(i&&!e.index.$u.test.date(t)?t=this.minDate:i||t||(t=`${e.index.$u.padZero(this.minHour)}:${e.index.$u.padZero(this.minMinute)}`),i)return t=e.dayjs(t).isBefore(e.dayjs(this.minDate))?this.minDate:t,t=e.dayjs(t).isAfter(e.dayjs(this.maxDate))?this.maxDate:t;{if(-1===String(t).indexOf(":"))return e.index.$u.error("时间错误，请传递如12:24的格式");let[i,n]=t.split(":");return i=e.index.$u.padZero(e.index.$u.range(this.minHour,this.maxHour,Number(i))),n=e.index.$u.padZero(e.index.$u.range(this.minMinute,this.maxMinute,Number(n))),`${i}:${n}`}},getRanges(){if("time"===this.mode)return[{type:"hour",range:[this.minHour,this.maxHour]},{type:"minute",range:[this.minMinute,this.maxMinute]}];const{maxYear:e,maxDate:t,maxMonth:i,maxHour:n,maxMinute:r}=this.getBoundary("max",this.innerValue),{minYear:a,minDate:s,minMonth:o,minHour:m,minMinute:u}=this.getBoundary("min",this.innerValue),h=[{type:"year",range:[a,e]},{type:"month",range:[o,i]},{type:"day",range:[s,t]},{type:"hour",range:[m,n]},{type:"minute",range:[u,r]}];return"date"===this.mode&&h.splice(3,2),"year-month"===this.mode&&h.splice(2,3),h},getBoundary(t,i){const n=new Date(i),r=new Date(this[`${t}Date`]),a=e.dayjs(r).year();let s=1,o=1,m=0,u=0;return"max"===t&&(s=12,o=e.dayjs(n).daysInMonth(),m=23,u=59),e.dayjs(n).year()===a&&(s=e.dayjs(r).month()+1,e.dayjs(n).month()+1===s&&(o=e.dayjs(r).date(),e.dayjs(n).date()===o&&(m=e.dayjs(r).hour(),e.dayjs(n).hour()===m&&(u=e.dayjs(r).minute())))),{[`${t}Year`]:a,[`${t}Month`]:s,[`${t}Date`]:o,[`${t}Hour`]:m,[`${t}Minute`]:u}}}};if(!Array){e.resolveComponent("u-picker")()}Math;const a=e._export_sfc(r,[["render",function(t,i,n,r,a,s){return{a:e.sr("picker","a0b8deb6-0"),b:e.o(s.close),c:e.o(s.cancel),d:e.o(s.confirm),e:e.o(s.change),f:e.p({show:t.show,closeOnClickOverlay:t.closeOnClickOverlay,columns:a.columns,title:t.title,itemHeight:t.itemHeight,showToolbar:t.showToolbar,visibleItemCount:t.visibleItemCount,defaultIndex:a.innerDefaultIndex,cancelText:t.cancelText,confirmText:t.confirmText,cancelColor:t.cancelColor,confirmColor:t.confirmColor})}}],["__scopeId","data-v-a0b8deb6"]]);wx.createComponent(a);
