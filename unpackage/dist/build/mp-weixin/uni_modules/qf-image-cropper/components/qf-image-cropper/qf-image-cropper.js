"use strict";const t=require("../../../../common/vendor.js"),e=t=>{t.wxsCallMethods||(t.wxsCallMethods=[]),t.wxsCallMethods.push("dataChange")},i={name:"qf-image-cropper",options:{styleIsolation:"isolated"},props:{src:{type:String,default:""},width:{type:Number,default:300},height:{type:Number,default:300},showBorder:{type:Boolean,default:!0},showGrid:{type:Boolean,default:!0},showAngle:{type:Boolean,default:!0},areaScale:{type:Number,default:.3},minScale:{type:Number,default:1},maxScale:{type:Number,default:5},checkRange:{type:Boolean,default:!0},backgroundColor:{type:String},bounce:{type:Boolean,default:!0},rotatable:{type:Boolean,default:!0},reverseRotatable:{type:Boolean,default:!1},choosable:{type:Boolean,default:!0},gpu:{type:Boolean,default:!1},angleSize:{type:Number,default:20},angleBorderWidth:{type:Number,default:2},zIndex:{type:[Number,String]},radius:{type:Number,default:0},fileType:{type:String,default:"png"},delay:{type:Number,default:1e3}},emits:["crop"],data:()=>({maskList:[{id:"crop-mask-block-1"},{id:"crop-mask-block-2"},{id:"crop-mask-block-3"},{id:"crop-mask-block-4"}],gridList:[{id:"crop-grid-1"},{id:"crop-grid-2"},{id:"crop-grid-3"},{id:"crop-grid-4"}],angleList:[{id:"crop-angle-1"},{id:"crop-angle-2"},{id:"crop-angle-3"},{id:"crop-angle-4"}],imgSrc:"",imgWidth:300,imgHeight:300,widthPercent:75,heightPercent:75,area:{},oldWidth:0,oldHeight:0,sys:t.index.getSystemInfoSync(),scaleWidth:0,scaleHeight:0,rotate:0,offsetX:0,offsetY:0,use2d:!1,canvansWidth:0,canvansHeight:0}),computed:{initData(){return{timestamp:(new Date).getTime(),area:{...this.area,bounce:this.bounce,showBorder:this.showBorder,showGrid:this.showGrid,showAngle:this.showAngle,angleSize:this.angleSize,angleBorderWidth:this.angleBorderWidth,minScale:this.areaScale,widthPercent:this.widthPercent,heightPercent:this.heightPercent,radius:this.radius,checkRange:this.checkRange,zIndex:+this.zIndex||0},sys:this.sys,img:{minScale:this.minScale,maxScale:this.maxScale,src:this.imgSrc,width:this.oldWidth,height:this.oldHeight,oldWidth:this.oldWidth,oldHeight:this.oldHeight,gpu:this.gpu}}},imgProps(){return{width:this.width,height:this.height,src:this.src}}},watch:{imgProps:{handler(t,e){this.imgWidth=Number(t.width)||300,this.imgHeight=Number(t.height)||300;let i=this.imgWidth,s=this.imgHeight,h=Math.max(i,s),a=1;h>1365&&(a=1365/h),this.canvansWidth=i*a,this.canvansHeight=s*a,this.use2d=!0,this.initArea();const o=t.src||this.imgSrc;o&&this.initImage(o,void 0===e)},immediate:!0}},methods:{dataChange(t){this.scaleWidth=t.width,this.scaleHeight=t.height,this.rotate=t.rotate,this.offsetX=t.x,this.offsetY=t.y},initArea(){this.sys.offsetBottom=t.index.upx2px(100)+this.sys.safeAreaInsets.bottom,this.sys.windowTop=0,this.sys.navigation=!0;let e=this.widthPercent,i=this.heightPercent;this.imgWidth>this.imgHeight?i=i*this.imgHeight/this.imgWidth:this.imgWidth<this.imgHeight&&(e=e*this.imgWidth/this.imgHeight);const s=this.sys.windowWidth>this.sys.windowHeight?this.sys.windowHeight:this.sys.windowWidth,h=s*e/100,a=s*i/100,o=(this.sys.windowWidth-h)/2,d=o+h,r=(this.sys.windowHeight+this.sys.windowTop-this.sys.offsetBottom-a)/2,n=this.sys.windowHeight+this.sys.windowTop-this.sys.offsetBottom-r;this.area={width:h,height:a,left:o,right:d,top:r,bottom:n},this.scaleWidth=h,this.scaleHeight=a},chooseImage(e){t.index.chooseMedia?t.index.chooseMedia({...e,count:1,mediaType:["image"],success:t=>{this.resetData(),this.initImage(t.tempFiles[0].tempFilePath)}}):t.index.chooseImage({...e,count:1,success:t=>{this.resetData(),this.initImage(t.tempFiles[0].path)}})},resetData(){this.imgSrc="",this.rotate=0,this.offsetX=0,this.offsetY=0,this.initArea()},initImage(e,i){t.index.getImageInfo({src:e,success:async t=>{i&&this.src===e&&await new Promise((t=>setTimeout(t,50))),this.imgSrc=t.path;let s=t.width/t.height,h=this.area.width/this.area.height;s>1?s>=h?this.scaleWidth=this.scaleHeight/t.height*this.scaleWidth*(t.width/this.scaleWidth):this.scaleHeight=t.height*this.scaleWidth/t.width:s<=h?this.scaleHeight=this.scaleWidth/t.width*this.scaleHeight/(this.scaleHeight/t.height):this.scaleWidth=t.width*this.scaleHeight/t.height,this.oldWidth=+this.scaleWidth.toFixed(2),this.oldHeight=+this.scaleHeight.toFixed(2)},fail:t=>{console.error(t)}})},drawClipImage(t,e,i,s){if(e>0){t.save(),t.beginPath();const i=this.canvansWidth,h=this.canvansHeight;i===h&&e>=i/2?t.arc(i/2,h/2,i/2,0,2*Math.PI):(i!==h&&(e=Math.min(i/2,h/2,e)),t.moveTo(e,0),t.arcTo(i,0,i,h,e),t.arcTo(i,h,0,h,e),t.arcTo(0,h,0,0,e),t.arcTo(0,0,i,0,e),t.closePath()),t.clip(),s&&s(!0),t.restore()}else s&&s(!1)},drawRotateImage(t,e,i){if(0!==e){const s=this.scaleWidth*i/2,h=this.scaleHeight*i/2;t.translate(s,h),t.rotate(e*Math.PI/180),t.translate(-s,-h)}},drawImage(t,e,i){const s=this.canvansWidth/this.area.width;this.backgroundColor&&(t.setFillStyle?t.setFillStyle(this.backgroundColor):t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.canvansWidth,this.canvansHeight)),this.drawClipImage(t,this.radius,s,(()=>{this.drawRotateImage(t,this.rotate,s);const i=this.rotate/90;t.drawImage(e,[this.offsetX-this.area.left,this.offsetY-this.area.top,-(this.offsetX-this.area.left),-(this.offsetY-this.area.top)][i]*s,[this.offsetY-this.area.top,-(this.offsetX-this.area.left),-(this.offsetY-this.area.top),this.offsetX-this.area.left][i]*s,this.scaleWidth*s,this.scaleHeight*s)}))},draw2DImage(e,i,s,h){if(e){const a=e.createImage();a.onload=()=>{this.drawImage(i,a),h&&setTimeout(h,this.delay)},a.onerror=e=>{console.error(e),t.index.hideLoading()},a.src=s}else this.drawImage(i,s),setTimeout((()=>{i.draw(!1,h)}),200)},canvasToTempFilePath(e,i){t.index.canvasToTempFilePath({canvas:e,canvasId:i,x:0,y:0,width:this.canvansWidth,height:this.canvansHeight,destWidth:this.imgWidth,destHeight:this.imgHeight,fileType:this.fileType,success:t=>{this.handleImage(t.tempFilePath)},fail:e=>{t.index.hideLoading(),t.index.showToast({title:"裁剪失败，生成图片异常！",icon:"none"})}},this)},cropClick(){if(t.index.showLoading({title:"裁剪中...",mask:!0}),!this.use2d){const e=t.index.createCanvasContext("imgCanvas",this);return e.clearRect(0,0,this.canvansWidth,this.canvansHeight),void this.draw2DImage(null,e,this.imgSrc,(()=>{this.canvasToTempFilePath(null,"imgCanvas")}))}t.index.createSelectorQuery().in(this).select("#imgCanvas").fields({node:!0,size:!0}).exec((e=>{const i=e[0].node,s=t.index.getSystemInfoSync().pixelRatio;i.width=e[0].width*s,i.height=e[0].height*s;const h=i.getContext("2d");h.scale(s,s),h.clearRect(0,0,this.canvansWidth,this.canvansHeight),this.draw2DImage(i,h,this.imgSrc,(()=>{this.canvasToTempFilePath(i)}))}))},handleImage(e){t.index.hideLoading(),this.$emit("crop",{tempFilePath:e})}}};e(i);const s=t._export_sfc(i,[["render",function(e,i,s,h,a,o){return t.e({a:a.use2d},a.use2d?{b:`${a.canvansWidth}px`,c:`${a.canvansHeight}px`}:{d:`${a.canvansWidth}px`,e:`${a.canvansHeight}px`},{f:a.imgSrc},a.imgSrc?{g:a.imgSrc}:{},{h:t.f(a.maskList,((t,e,i)=>({a:t.id,b:t.id}))),i:s.showBorder},(s.showBorder,{}),{j:s.radius>0},(s.radius,{}),{k:s.showGrid},s.showGrid?{l:t.f(a.gridList,((t,e,i)=>({a:t.id,b:t.id})))}:{},{m:s.showAngle},s.showAngle?{n:t.f(a.angleList,((t,e,i)=>({a:t.id,b:t.id}))),o:t.s({width:`${s.angleSize}px`,height:`${s.angleSize}px`})}:{},{p:o.initData,q:(s.rotatable||s.reverseRotatable)&&!!a.imgSrc},(s.rotatable||s.reverseRotatable)&&a.imgSrc?t.e({r:s.reverseRotatable},(s.reverseRotatable,{}),{s:s.rotatable},(s.rotatable,{})):{},{t:!s.choosable},s.choosable?a.imgSrc?{x:t.o(((...t)=>o.chooseImage&&o.chooseImage(...t))),y:t.o(((...t)=>o.cropClick&&o.cropClick(...t)))}:{z:t.o(((...t)=>o.chooseImage&&o.chooseImage(...t)))}:{v:t.o(((...t)=>o.cropClick&&o.cropClick(...t)))},{w:!!a.imgSrc,A:o.initData.area.zIndex+99,B:s.zIndex})}],["__scopeId","data-v-c520dff9"]]);wx.createComponent(s);
