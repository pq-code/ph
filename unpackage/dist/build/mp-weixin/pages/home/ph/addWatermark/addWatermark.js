"use strict";const e=require("../../../../common/vendor.js"),o=require("./hooks/useImageHandler.js"),a=require("./hooks/useWatermark.js"),n=require("./hooks/useWatermarkForm.js"),t=require("./components/watermarkConfig.js");if(!Array){(e.resolveComponent("u-image")+e.resolveComponent("u-icon")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../../uni_modules/uview-plus/components/u-image/u-image.js")+(()=>"../../../../uni_modules/uview-plus/components/u-icon/u-icon.js")+r+l+(()=>"../../../../uni_modules/uview-plus/components/u-popup/u-popup.js")+s)();const s=()=>"../../../../components/pages/page.js",r=()=>"./components/WatermarkTypeSelector.js",l=()=>"./components/WatermarkForm.js",i={__name:"addWatermark",setup(s){const r=e.ref(1),l=e.ref(t.WATERMARK_TYPES[0].style),{imageInfo:i,isProcessing:u,handleImageSelect:c}=o.useImageHandler(),{addWatermark:d}=a.useWatermark("watermark"),{formData:m,getFormFields:v,validateForm:p,resetForm:h}=n.useWatermarkForm();e.onMounted((async()=>{try{const o=await new Promise(((o,a)=>{e.index.createSelectorQuery().select(".preview-wrapper").boundingClientRect((e=>{e?o(e):a(new Error("未能获取容器尺寸"))})).exec()}));((e,o)=>{i.value.canvasWidth=e,i.value.canvasHeight=o})(o.width,o.height),console.log("容器初始化完成，尺寸：",o)}catch(o){console.error("容器初始化失败:",o),e.index.showToast({title:"初始化失败，请重试",icon:"none"})}}));const f=e=>{console.log("style",e),l.value=e.style,r.value=e.id,i.value&&g()},g=async()=>{if(console.log("formData",m.value),i.value&&i.value.path&&l.value)try{const o=i.value;await d({image:o,style:l.value,info:m.value});const a=.2,n=.5,{x:t,y:s,drawWidth:r,drawHeight:u}=o,{tempFilePath:c}=await e.index.canvasToTempFilePath({canvasId:"watermark",fileType:"png",quality:1,x:t+a,y:s+a,width:r-n,height:u-n});console.log("生成图片成功",c),o.url=c;const v=e.index.createCanvasContext("watermark");v.clearRect(0,0,o.canvasWidth,o.canvasHeight),v.draw()}catch(o){console.error("更新水印出错",o),e.index.showToast({title:"更新水印出错",icon:"none"})}},w=async()=>{if(u.value)return;await c()&&await g()},x=async()=>{if(i.value)try{const{x:o,y:a,drawWidth:n,drawHeight:t}=i.value;console.log(i.value.url);const s=i.value.url;console.log("生成图片成功",s),e.index.showToast({title:"生成图片成功",icon:"success"}),e.index.previewImage({urls:[s],longPressActions:{itemList:["保存图片"],success:function(o){0===o.tapIndex&&e.index.saveImageToPhotosAlbum({filePath:s,success:function(){e.index.showToast({title:"保存成功",icon:"success"})},fail:function(o){console.error("保存失败",o),e.index.showToast({title:"保存失败",icon:"none"})}})},fail:function(e){console.error("长按操作失败",e)}}})}catch(o){console.error("生成图片出错",o),e.index.showToast({title:"生成图片出错",icon:"none"})}else e.index.showToast({title:"请先选择图片",icon:"none"})},y=e.ref(!1);function k(){y.value=!0}function W(){y.value=!1,g()}return(o,a)=>{var n,t,s,c,d,p,h;return e.e({a:null==(n=e.unref(i))?void 0:n.url},(null==(t=e.unref(i))?void 0:t.url)?{b:e.p({src:null==(s=e.unref(i))?void 0:s.url,mode:"aspectFit","lazy-load":!0,fade:!0,"show-menu-by-longpress":!0,width:(null==(c=e.unref(i))?void 0:c.canvasWidth)+"px",height:(null==(d=e.unref(i))?void 0:d.canvasHeight)+"px"})}:{c:e.p({name:"camera-fill",size:"40",color:"#999"})},{d:e.o(w),e:(null==(p=e.unref(i))?void 0:p.canvasWidth)+"px",f:(null==(h=e.unref(i))?void 0:h.canvasHeight)+"px",g:e.o(f),h:e.o((e=>r.value=e)),i:e.p({modelValue:r.value}),j:l.value},l.value?{k:e.o((o=>e.isRef(m)?m.value=o:null)),l:e.p({fields:e.unref(v)(l.value),disabled:e.unref(u),modelValue:e.unref(m)})}:{},{m:e.o(W),n:e.o(k),o:e.p({show:y.value,mode:"bottom",closeable:!0,overlay:!0,safeAreaInsetBottom:!0,round:10}),p:e.o(x),q:e.o((e=>y.value=!0)),r:e.p({title:"添加水印",rButton:"生成图片",lButton:"编辑",rButtonDisabled:e.unref(u)})})}}},u=e._export_sfc(i,[["__scopeId","data-v-cf56bdb3"]]);wx.createPage(u);
