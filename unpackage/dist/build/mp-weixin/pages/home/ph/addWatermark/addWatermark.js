"use strict";const e=require("../../../../common/vendor.js"),o=require("./hooks/useImageHandler.js"),n=require("./hooks/useWatermark.js"),a=require("./hooks/useWatermarkForm.js"),t=require("./components/watermarkConfig.js");if(!Array){(e.resolveComponent("u-image")+e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../../uni_modules/uview-plus/components/u-image/u-image.js")+(()=>"../../../../uni_modules/uview-plus/components/u-icon/u-icon.js")+r+(()=>"../../../../uni_modules/uview-plus/components/u-button/u-button.js")+l+(()=>"../../../../uni_modules/uview-plus/components/u-popup/u-popup.js")+s)();const s=()=>"../../../../components/pages/page.js",r=()=>"./components/WatermarkTypeSelector.js",l=()=>"./components/WatermarkForm.js",u={__name:"addWatermark",setup(s){const r=e.ref(1),l=e.ref(t.WATERMARK_TYPES[0]),{imageInfo:u,isProcessing:i,handleImageSelect:c}=o.useImageHandler(),{addWatermark:d}=n.useWatermark("watermark"),{formData:m,getFormFields:v,validateForm:p,resetForm:h}=a.useWatermarkForm();e.onMounted((async()=>{try{const o=await new Promise(((o,n)=>{e.index.createSelectorQuery().select(".preview-wrapper").boundingClientRect((e=>{e?o(e):n(new Error("未能获取容器尺寸"))})).exec()}));((e,o)=>{u.value.canvasWidth=e,u.value.canvasHeight=o})(o.width,o.height),console.log("容器初始化完成，尺寸：",o)}catch(o){console.error("容器初始化失败:",o),e.index.showToast({title:"初始化失败，请重试",icon:"none"})}}));const f=e=>{console.log("style",e),l.value=e,r.value=e.id,u.value&&g()},g=async()=>{if(console.log("formData",m.value),u.value&&u.value.path&&l.value)try{const o=u.value;await d({image:o,style:l.value,info:m.value});const n=.2,a=.5,{x:t,y:s,drawWidth:r,drawHeight:i}=o,{tempFilePath:c}=await e.index.canvasToTempFilePath({canvasId:"watermark",fileType:"png",quality:1,x:t+n,y:s+n,width:r-a,height:i-a});console.log("生成图片成功",c),o.url=c;const v=e.index.createCanvasContext("watermark");v.clearRect(0,0,o.canvasWidth,o.canvasHeight),v.draw()}catch(o){console.error("更新水印出错",o),e.index.showToast({title:"更新水印出错",icon:"none"})}},w=async()=>{if(i.value)return;await c()&&await g()},x=async()=>{if(u.value)try{const{x:o,y:n,drawWidth:a,drawHeight:t}=u.value;console.log(u.value.url);const s=u.value.url;console.log("生成图片成功",s),e.index.showToast({title:"生成图片成功",icon:"success"}),e.index.previewImage({urls:[s],longPressActions:{itemList:["保存图片"],success:function(o){0===o.tapIndex&&e.index.saveImageToPhotosAlbum({filePath:s,success:function(){e.index.showToast({title:"保存成功",icon:"success"})},fail:function(o){console.error("保存失败",o),e.index.showToast({title:"保存失败",icon:"none"})}})},fail:function(e){console.error("长按操作失败",e)}}})}catch(o){console.error("生成图片出错",o),e.index.showToast({title:"生成图片出错",icon:"none"})}else e.index.showToast({title:"请先选择图片",icon:"none"})},y=e.ref(!1);function k(){y.value=!0}function T(){y.value=!1,g()}return(o,n)=>{var a,s,c,d,v,p,h;return e.e({a:null==(a=e.unref(u))?void 0:a.url},(null==(s=e.unref(u))?void 0:s.url)?{b:e.p({src:null==(c=e.unref(u))?void 0:c.url,mode:"aspectFit","lazy-load":!0,fade:!0,"show-menu-by-longpress":!0,width:(null==(d=e.unref(u))?void 0:d.canvasWidth)+"px",height:(null==(v=e.unref(u))?void 0:v.canvasHeight)+"px"})}:{c:e.p({name:"camera-fill",size:"40",color:"#999"})},{d:e.o(w),e:(null==(p=e.unref(u))?void 0:p.canvasWidth)+"px",f:(null==(h=e.unref(u))?void 0:h.canvasHeight)+"px",g:e.o(f),h:e.o((e=>r.value=e)),i:e.p({modelValue:r.value}),j:e.o(T),k:l.value},l.value?{l:e.o((o=>e.isRef(m)?m.value=o:null)),m:e.p({fields:e.unref(t.WATERMARK_FORM_LIST)[l.value.id],disabled:e.unref(i),modelValue:e.unref(m)})}:{},{n:e.o(T),o:e.o(k),p:e.p({show:y.value,mode:"bottom",closeable:!1,overlay:!0,safeAreaInsetBottom:!0,round:7}),q:e.o(x),r:e.o((e=>y.value=!0)),s:e.p({title:"添加水印",rButton:"生成图片",lButton:"编辑",rButtonDisabled:e.unref(i)})})}}},i=e._export_sfc(u,[["__scopeId","data-v-733f5543"]]);wx.createPage(i);
