"use strict";const e=require("../../../../../common/vendor.js"),t=require("../../../../../libs/qqmap-wx-jssdk.js");if(!Array){(e.resolveComponent("u-input")+e.resolveComponent("u-button"))()}Math||((()=>"../../../../../uni_modules/uview-plus/components/u-input/u-input.js")+(()=>"../../../../../uni_modules/uview-plus/components/u-button/u-button.js"))();const o={__name:"MapDisplay",emits:["closeMap"],setup(o,{emit:n}){const s=n,a=e.ref({}),l=e.ref(30.254515),i=e.ref(120.11),c=e.ref(13),r=e.ref(null);let u=null;const d=e.ref(""),v=e.ref([]),p=e.ref("");e.ref(null);const g=e.ref([]),m=e=>{s("closeMap",e||a.value)};e.onMounted((()=>{u=new t.QQMapWX({key:"TINBZ-DRE6I-H7XGE-UG7XQ-UGPHH-4ZBR6"}),h()})),e.onBeforeUnmount((()=>{r.value&&r.value.destroy(),delete window.mapInit}));const f=async()=>{if(d.value)try{u.search({keyword:d.value,region:"全国",page_size:20,keyword_auto_complete:1,address_format:"short",filter:"category=地址",success:function(t){if(console.log("res",t),0===t.status&&t.data){const o=new Map;v.value=t.data.filter((e=>{const t=`${e.location.lat},${e.location.lng}`;return!o.has(t)&&o.set(t,!0)})).map((e=>({title:e.title.replace(/<[^>]+>/g,""),lat:e.location.lat,lng:e.location.lng}))),0===v.value.length&&e.index.showToast({title:"query params error"===t.message?"请输入更详细的关键词":"未找到相关地址",icon:"none"})}}})}catch(t){console.error("搜索失败:",t),e.index.showToast({title:"搜索失败："+t.message,icon:"none"})}},h=()=>{e.index.authorize({scope:"scope.userLocation",success(){let t={longitude:i.value,latitude:l.value,province:"",city:"",area:"",street:"",address:""};e.index.getLocation({type:"gcj02",geocode:!0,success:function(o){e.index.setStorageSync("location",{latitude:l.value,longitude:i.value}),i.value=o.longitude,l.value=o.latitude,t.longitude=o.longitude,t.latitude=o.latitude,u.reverseGeocoder({location:t,success:function(e){let o=e.result;t.province=o.address_component.province,t.city=o.address_component.city,t.area=o.address_component.district,t.street=o.address_component.street,t.address=o.address,t.value=t}})},fail:function(t){console.log(t,"err"),u.geocoder({geocoder:1,success:t=>{const o=t.result.location;i.value=o.lng,l.value=o.lat,u.reverseGeocoder({location:o,success:function(t){t.result,e.index.setStorageSync("location",{latitude:o.lat,longitude:o.lng}),e.index.showToast({title:"已使用IP定位",icon:"none"})}})},fail:t=>{e.index.showToast({title:"定位失败，请手动选择位置",icon:"none"})}})}})},fail(){e.index.showToast({title:"需要位置权限才能使用该功能",icon:"none"})}})},y=e=>{var t,o;l.value=e.lat,i.value=e.lng,console.log("item",e),t=e.lat,o=e.lng,g.value=[{id:1,latitude:t,longitude:o,iconPath:"/static/location.png",width:30,height:30}],u.reverseGeocoder({location:{latitude:e.lat,longitude:e.lng},success:function(t){const o=t.result;p.value=o.address,a.value={longitude:e.lng,latitude:e.lat,province:o.address_component.province,city:o.address_component.city,area:o.address_component.district,street:o.address_component.street,address:o.address}}}),v.value=[],d.value=""},_=t=>{const{latitude:o,longitude:n}=t.detail;a.value={longitude:n,latitude:o,province:"",city:"",area:"",street:"",address:""},u.reverseGeocoder({location:{latitude:o,longitude:n},success:function(t){const o=t.result;p.value=o.address,a.value={...a.value,province:o.address_component.province,city:o.address_component.city,area:o.address_component.district,street:o.address_component.street,address:o.address},e.index.showModal({title:"确认位置",content:`是否选择当前位置：${o.address}`,success:function(e){e.confirm&&m(a.value)}})},fail:function(e){console.error("逆地理编码失败:",e)}})};return(t,o)=>e.e({a:e.o(f),b:e.o((e=>d.value=e)),c:e.p({placeholder:"输入地址进行搜索",modelValue:d.value}),d:e.o(f),e:e.o(m),f:p.value},p.value?{g:e.t(p.value)}:{},{h:v.value.length>0},v.value.length>0?{i:e.f(v.value,((t,o,n)=>({a:e.t(t.title),b:o,c:e.o((e=>y(t)),o)})))}:{},{j:l.value,k:i.value,l:c.value,m:e.o(_),n:g.value,o:e.o((e=>t.toMap()))})}};wx.createComponent(o);
