"use strict";const t=require("../../../../../common/vendor.js");exports.useWatermark=e=>({addWatermark:async({image:a,style:s,info:i})=>{if(null==a?void 0:a.path)try{const l=t.index.createCanvasContext(e);l.clearRect(0,0,a.canvasWidth,a.canvasHeight),l.drawImage(a.path,a.x,a.y,a.drawWidth,a.drawHeight);const o={x:a.x,y:a.y,drawWidth:a.drawWidth,drawHeight:a.drawHeight};1===s.id?(i.isOnSitePhotography&&((t,e)=>{const{x:a,y:s,drawWidth:i,drawHeight:l}=e;t.save();const o=a+i/2,r=s+l/2,n=.08*Math.min(i,l);t.translate(o,r),t.setTextAlign("center"),t.setTextBaseline("middle"),t.setFontSize(n),t.font=`bold ${n}px sans-serif`;const d="现场拍照";t.setGlobalAlpha(.5),t.setLineWidth(2),t.setStrokeStyle("#FFFFFF"),t.strokeText(d,0,0),t.setGlobalAlpha(.5),t.setFillStyle("#666666"),t.fillText(d,0,0),t.restore()})(l,o),((e,a,s)=>{const{x:i,y:l,drawWidth:o,drawHeight:r}=a;e.setFontSize(14),e.setTextAlign("left"),e.setTextBaseline("top");const n=[`经度：${s.longitude||"121.0126"}`,`纬度：${s.latitude||"31.288511"}`,"坐标：WGS84坐标系",`地址：${s.address||""}`,`时间：${s.datetime||t.dayjs().format("YYYY-MM-DD HH:mm:ss")}`,`备注：${s.remark||"编辑备注"}`];let d=l+r-21*n.length-10;e.setGlobalAlpha(1),e.setFillStyle("#FFFFFF"),n.forEach((t=>{e.fillText(t,i+10,d),d+=21}))})(l,o,i)):2===s.id&&((t,e,a)=>{const{x:s,y:i,drawWidth:l,drawHeight:o}=e,r=a.fontSize||18;t.save(),t.setFontSize(r),t.setTextAlign("center"),t.setTextBaseline("middle"),t.font=`bold ${r}px sans-serif`,t.translate(s+l/2,i+o/2),t.rotate((a.angle||-15)*Math.PI/180),t.setGlobalAlpha((a.opacity??30)/100);const n=a.watermarkContent||"保密",d=a.density||100,h=Math.ceil(l/d)+2,c=Math.ceil(o/d)+2;t.strokeStyle=a.strokeColor||"#FFFFFF",t.lineWidth=a.strokeWidth||2,t.setFillStyle(a.fillColor||"#666666");for(let F=-h;F<=h;F++)for(let e=-c;e<=c;e++)t.strokeText(n,F*d,e*d),t.fillText(n,F*d,e*d);t.restore()})(l,o,i),await new Promise((t=>l.draw(!1,t)))}catch(l){console.error("绘制失败:",l),t.index.showToast({title:"绘制失败",icon:"none"})}else console.error("无效的图片路径")}});
